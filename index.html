<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMA Offer Configurator</title>
    <style>
        :root {
            --primary: #dc2626;
            --primary-hover: #991b1b;
            --secondary: #64748b;
            --bg: #f8fafc;
            --border: #cbd5e1;
            --stock-ok: #22c55e;
            --stock-low: #ef4444;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: #1e293b; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .container, .cart-container { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            max-width: 750px; 
            width: 100%; 
            margin-bottom: 20px; 
            position: relative;
        }

        .header-area { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        .logo-box img { max-height: 60px; width: auto; }

        h2, h3 { margin: 0; color: var(--primary); }

        .config-row { display: flex; gap: 20px; margin-bottom: 20px; background: #fff5f5; padding: 15px; border-radius: 8px; border: 1px solid #fee2e2; align-items: center; }
        .config-group { flex: 1; }

        .select-group { margin-bottom: 12px; }
        .label-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px; }
        label { display: block; font-size: 0.8rem; font-weight: 700; color: var(--secondary); text-transform: uppercase; }
        .stock-legend { font-size: 0.75rem; font-weight: 600; color: var(--secondary); }
        
        select, input[type="number"] { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; outline: none; background: white; box-sizing: border-box; }
        select:focus { border-color: var(--primary); }

        #col4 { border: 2px solid #e2e8f0; font-weight: 600; }

        .modifier-section { margin-top: 20px; padding: 15px; background: #fef2f2; border-radius: 8px; border: 1px solid #fee2e2; }
        .modifier-item { display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9rem; }
        .modifier-item input { margin-right: 10px; accent-color: var(--primary); width: 18px; height: 18px; cursor: pointer; }

        .btn-add { background-color: var(--primary); color: white; border: none; padding: 15px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 15px; font-size: 1.1rem; transition: 0.2s; }
        .btn-add:hover { background-color: var(--primary-hover); }

        .cart-item { border-bottom: 1px solid #eee; padding: 25px 0; line-height: 1.6; color: #334155; position: relative; }
        .item-title { font-weight: 800; font-size: 1.2rem; color: #000; display: block; margin-bottom: 8px; }
        .extra-opt { color: #dc2626; font-weight: 600; font-size: 0.85rem; display: block; margin-top: 2px; }
        
        .grand-total { margin-top: 20px; text-align: right; font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        .cart-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        
        .btn-secondary { background-color: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-secondary:hover { background-color: #e2e8f0; }

        .remove-btn { color: var(--primary); cursor: pointer; text-decoration: underline; font-size: 0.8rem; border: none; background: none; padding: 0; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-area">
        <div>
            <h2>Offer Configurator</h2>
        </div>
        <div class="logo-box">
            <img src="https://lirp.cdn-website.com/989d3493/dms3rep/multi/opt/zmbJX0ObTsmOY9cAxxS3_EMA+Netherlands_v1.0-1920w.png" alt="EMA Logo">
        </div>
    </div>
    
    <div class="config-row">
        <div class="config-group">
            <label>Client Discount (%)</label>
            <input type="number" id="global-discount" value="0" onchange="renderCart()">
        </div>
    </div>

    <div id="loader">Syncing data with Google Sheets...</div>
    
    <div id="main-ui" style="display:none;">
        <div class="select-group"><label>Material</label><select id="col0" onchange="handleSelectChange(0)"></select></div>
        <div class="select-group"><label>Poles</label><select id="col1" onchange="handleSelectChange(1)"></select></div>
        <div class="select-group"><label>Efficiency</label><select id="col2" onchange="handleSelectChange(2)"></select></div>
        <div class="select-group"><label>Power kW</label><select id="col3" onchange="handleSelectChange(3)"></select></div>
        
        <div class="select-group">
            <div class="label-row">
                <label>Type & Availability</label>
                <span class="stock-legend">ðŸŸ¢ In Stock | ðŸ”´ Out of Stock</span>
            </div>
            <select id="col4" onchange="handleSelectChange(4)"></select>
        </div>

        <div id="modifier-area" class="modifier-section">
            <label>Extra Options & Modifications:</label>
            <div id="modifier-list">Please select a motor to see options...</div>
        </div>

        <button class="btn-add" onclick="addToCart()">+ Add to Offer Overview</button>
    </div>
</div>

<div class="cart-container" id="cart-section" style="display: none;">
    <h3>Offer Overview</h3>
    <div id="cart-items"></div>
    <div class="grand-total" id="grand-total-display">Total: â‚¬ 0.00</div>
    
    <div class="cart-actions">
        <button class="btn-secondary" onclick="copyCartToClipboard()">ðŸ“‹ Copy Selection</button>
        <button class="btn-secondary" style="color: var(--primary)" onclick="clearCart()">ðŸ—‘ Clear All</button>
    </div>
</div>

<script>
const baseSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdeTFdaPb_8qPBhm-NlXIXmoH9KxwEfqOucxBG40OShY72eJW6uaR-84C7pmO7WcP9WgVzmWH9vGd_/pub?single=true&output=csv';
const priceGID = '0'; 
const stockGID = '713664103'; 

let tabelData = [];
let voorraadData = {}; 
let cart = [];
let lastType = "";

async function initialiseren() {
    try {
        const pResp = await fetch(`${baseSheetURL}&gid=${priceGID}`);
        const pText = await pResp.text();
        tabelData = pText.split(/\r?\n/).slice(1).map(parsePrijsRegel).filter(i => i);
        try {
            const sResp = await fetch(`${baseSheetURL}&gid=${stockGID}`);
            const sText = await sResp.text();
            parseVoorraad(sText);
        } catch (e) { console.warn("Stock GID not found."); }
        updateDropdowns(0);
        document.getElementById('loader').style.display = 'none';
        document.getElementById('main-ui').style.display = 'block';
    } catch (e) { document.getElementById('loader').textContent = "Error loading data."; }
}

function cleanNumber(val) {
    if (!val) return 0;
    let s = val.toString().replace(/[^\d,.-]/g, '');
    if (s.includes(',') && s.includes('.')) {
        if (s.lastIndexOf('.') > s.lastIndexOf(',')) s = s.replace(/,/g, '');
        else s = s.replace(/\./g, '').replace(',', '.');
    } else { s = s.replace(',', '.'); }
    return parseFloat(s) || 0;
}

function parsePrijsRegel(r) {
    const cols = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
    if (cols.length < 6) return null;
    const mods = {};
    const modCel = cols[6]?.replace(/"/g, '').trim() || "";
    if (modCel) {
        modCel.split(/,(?=[^:]+:)/).forEach(m => {
            const idx = m.lastIndexOf(':');
            if (idx !== -1) mods[m.substring(0, idx).trim()] = cleanNumber(m.substring(idx+1));
        });
    }
    return {
        kenmerken: cols.slice(0, 5).map(s => s.trim().replace(/"/g, '')),
        prijs: cleanNumber(cols[5]),
        modifiers: mods
    };
}

function parseVoorraad(csv) {
    csv.split(/\r?\n/).slice(1).forEach(r => {
        const cols = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        if (cols.length >= 2) {
            voorraadData[cols[0].trim().replace(/"/g, '')] = parseInt(cols[1].replace(/[^\d]/g, '')) || 0;
        }
    });
}

function handleSelectChange(idx) {
    const currentVal = document.getElementById(`col${idx}`).value;
    
    // Als we een waarde hebben gekozen, check of er nog maar 1 unieke optie overblijft voor de andere velden
    if (currentVal !== "") {
        const currentPicks = [0,1,2,3,4].map(i => document.getElementById(`col${i}`).value);
        
        // Filter data op basis van wat nu geselecteerd is
        const possibleMatches = tabelData.filter(item => {
            return currentPicks.every((pick, i) => pick === "" || item.kenmerken[i] === pick);
        });

        // Als er maar 1 motor overblijft, vul alle velden in
        if (possibleMatches.length === 1) {
            const match = possibleMatches[0];
            for (let i = 0; i < 5; i++) {
                const el = document.getElementById(`col${i}`);
                if (el.value === "") {
                    // We moeten de dropdown eerst vullen met de juiste optie als die er nog niet in stond
                    updateSingleDropdown(i, match.kenmerken[i]);
                    el.value = match.kenmerken[i];
                }
            }
        }
    }

    // Update de dropdowns die 'stroomafwaarts' liggen
    for (let i = idx + 1; i < 5; i++) {
        if (document.getElementById(`col${i}`).value === "") {
            updateDropdowns(i);
        }
    }
    
    updateMainUI();
}

// Hulpfunctie om een dropdown te forceren naar een specifieke waarde als hij leeg is
function updateSingleDropdown(idx, value) {
    const select = document.getElementById(`col${idx}`);
    if (select.innerHTML === "" || select.querySelector(`option[value="${value}"]`) === null) {
        let label = value;
        if (idx === 4) {
            const stock = voorraadData[value] || 0;
            label = (stock > 0 ? `ðŸŸ¢ ${value} (${stock} pcs)` : `ðŸ”´ ${value} (Out of stock)`);
        }
        select.innerHTML = `<option value="">Select...</option><option value="${value}">${label}</option>`;
    }
}

function updateDropdowns(startIdx) {
    const picks = [0,1,2,3,4].map(i => document.getElementById(`col${i}`).value);
    
    for (let i = startIdx; i < 5; i++) {
        const select = document.getElementById(`col${i}`);
        // Als het veld al is ingevuld door de auto-fill, sla het over tenzij we expliciet resetten
        if (select.value !== "" && i < startIdx) continue;

        const filtered = tabelData.filter(item => {
            for (let j = 0; j < 5; j++) { 
                if (i !== j && picks[j] !== "" && item.kenmerken[j] !== picks[j]) return false; 
            }
            return true;
        });
        
        const opts = [...new Set(filtered.map(item => item.kenmerken[i]))].sort((a,b) => a.localeCompare(b, undefined, {numeric:true}));
        
        const currentVal = select.value;
        let html = '<option value="">Select...</option>';
        opts.forEach(o => {
            let label = o;
            if (i === 4) {
                const stock = voorraadData[o] || 0;
                label = (stock > 0 ? `ðŸŸ¢ ${o} (${stock} pcs)` : `ðŸ”´ ${o} (Out of stock)`);
            }
            html += `<option value="${o}" ${o === currentVal ? 'selected' : ''}>${label}</option>`;
        });
        select.innerHTML = html;
    }
}

function updateMainUI() {
    const picks = [0,1,2,3,4].map(i => document.getElementById(`col${i}`).value);
    const listDiv = document.getElementById('modifier-list');
    if (picks.includes("")) { 
        listDiv.innerHTML = "Select motor details..."; 
        lastType = "";
        return; 
    }
    const currentType = picks[4];
    if (currentType !== lastType) {
        lastType = currentType;
        const match = tabelData.find(item => item.kenmerken.every((v, i) => v === picks[i]));
        if (match) {
            listDiv.innerHTML = Object.entries(match.modifiers).map(([naam, perc]) => `
                <div class="modifier-item">
                    <input type="checkbox" class="mod-check" data-name="${naam}" value="${perc}">
                    <span>${naam} (+${perc}%)</span>
                </div>
            `).join('');
        }
    }
}

function addToCart() {
    const picks = [0,1,2,3,4].map(i => document.getElementById(`col${i}`).value);
    if (picks.includes("")) return;
    const match = tabelData.find(item => item.kenmerken.every((v, i) => v === picks[i]));
    const discount = parseFloat(document.getElementById('global-discount').value) || 0;
    const stockCount = voorraadData[picks[4]] || 0;

    let mounting = "B3", protection = "IP55", insulation = "Class F", voltage = "400V / 690V", freq = "50 Hz";
    let copper = 0, extraPrice = 0, otherMods = [];

    document.querySelectorAll('.mod-check:checked').forEach(cb => {
        const name = cb.getAttribute('data-name');
        const val = parseFloat(cb.value);
        extraPrice += (match.prijs * (val/100));
        const n = name.toUpperCase();
        if (["B5", "B35", "B14A", "V1"].some(m => n.includes(m))) mounting = name;
        else if (n.includes("IP66")) protection = "IP66";
        else if (n.includes("H-CLASS") || n.includes("TYPE H")) insulation = "Class H";
        else if (n.includes("440") || n.includes("460") || n.includes("60HZ")) { voltage = "440V / 460V"; freq = "60 Hz"; }
        else if (n.includes("COPPER")) copper = val;
        else otherMods.push(name);
    });

    cart.push({
        type: match.kenmerken[4],
        base: match.prijs,
        copper: copper,
        discount: discount,
        total: match.prijs + extraPrice,
        inStock: stockCount > 0,
        specs: { 
            eff: match.kenmerken[2], pow: match.kenmerken[3], pol: match.kenmerken[1], 
            mat: match.kenmerken[0], mnt: mounting, prt: protection, ins: insulation,
            vol: voltage, frq: freq, others: otherMods
        }
    });
    renderCart();
}

function renderCart() {
    const container = document.getElementById('cart-items');
    const section = document.getElementById('cart-section');
    if (cart.length > 0) section.style.display = 'block';
    container.innerHTML = '';
    let grandTotal = 0;
    const globalDiscount = parseFloat(document.getElementById('global-discount').value) || 0;

    cart.forEach((item, index) => {
        const finalPrice = item.total * (1 - (globalDiscount / 100));
        grandTotal += finalPrice;
        const deliv = item.inStock ? "on stock, while stock last" : "4-6 weeks (to be confirmed)";

        container.innerHTML += `
            <div class="cart-item">
                <span class="item-title">1x ${item.type}</span>
                Brand: Electric Motors Amsterdam (EMA)<br>
                Safe Area Motor<br>
                Price: â‚¬ ${item.base.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} each<br>
                Copper surcharge: ${item.copper}%<br>
                Discount: ${globalDiscount}%<br>
                <strong>Total Price: â‚¬ ${finalPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} each</strong><br>
                Delivery time: ${deliv}<br>
                Efficiency class: ${item.specs.eff} | Power: ${item.specs.pow} kW | Poles: ${item.specs.pol}<br>
                Voltage: ${item.specs.vol} | Frequency: ${item.specs.frq}<br>
                Insulation: ${item.specs.ins} | Protection Class: ${item.specs.prt}<br>
                Mounting: ${item.specs.mnt} | Material: ${item.specs.mat.toLowerCase()}
                ${item.specs.others.map(o => `<span class="extra-opt">+ ${o}</span>`).join('')}
                <br><button class="remove-btn" onclick="removeFromCart(${index})">Remove item</button>
            </div>
        `;
    });
    document.getElementById('grand-total-display').textContent = `Total: â‚¬ ${grandTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

function removeFromCart(index) {
    cart.splice(index, 1);
    if (cart.length === 0) document.getElementById('cart-section').style.display = 'none';
    renderCart();
}

function clearCart() {
    if (confirm("Are you sure you want to clear the entire list?")) {
        cart = [];
        document.getElementById('cart-section').style.display = 'none';
        renderCart();
    }
}

function copyCartToClipboard() {
    let textToCopy = "OFFER OVERVIEW - Electric Motors Amsterdam B.V.\n";
    textToCopy += "========================================\n\n";
    
    const globalDiscount = parseFloat(document.getElementById('global-discount').value) || 0;
    let grandTotal = 0;

    cart.forEach((item, index) => {
        const finalPrice = item.total * (1 - (globalDiscount / 100));
        grandTotal += finalPrice;
        const deliv = item.inStock ? "on stock, while stock last" : "4-6 weeks (to be confirmed)";
        
        textToCopy += `${index + 1}. 1x ${item.type}\n`;
        textToCopy += `   Price: â‚¬ ${item.base.toLocaleString('en-US', {minimumFractionDigits: 2})} each\n`;
        textToCopy += `   Copper surcharge: ${item.copper}%\n`;
        textToCopy += `   Discount: ${globalDiscount}%\n`;
        textToCopy += `   Total Price: â‚¬ ${finalPrice.toLocaleString('en-US', {minimumFractionDigits: 2})} each\n`;
        textToCopy += `   Delivery time: ${deliv}\n`;
        textToCopy += `   Specs: ${item.specs.eff}, ${item.specs.pow}kW, ${item.specs.pol} poles, ${item.specs.vol}, ${item.specs.mnt}, ${item.specs.mat}\n`;
        if(item.specs.others.length > 0) textToCopy += `   Extras: ${item.specs.others.join(', ')}\n`;
        textToCopy += "\n";
    });

    textToCopy += "----------------------------------------\n";
    textToCopy += `GRAND TOTAL: â‚¬ ${grandTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}\n`;
    textToCopy += "----------------------------------------\n";

    navigator.clipboard.writeText(textToCopy).then(() => {
        alert("Selection copied to clipboard!");
    }).catch(err => {
        console.error('Failed to copy: ', err);
    });
}

initialiseren();
</script>

</body>
</html>
